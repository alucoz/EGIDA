<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa GPS na żywo</title>

    <!-- Biblioteki Leaflet (bez zmian) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- USUNIĘTO: Linki do wtyczki siatki -->

    <style>
        body { font-family: system-ui, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 700px; margin: 15px; padding: 25px 30px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #1c1e21; margin-bottom: 20px; }
        .data-point { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-size: 1.1em; }
        .label { font-weight: 600; color: #606770; }
        .value { color: #1877f2; font-family: "Courier New", Courier, monospace; font-weight: bold; }
        .value.manual { color: #28a745; } /* Zielony kolor dla ręcznego punktu */
        .value.distance { color: #dc3545; } /* Czerwony kolor dla dystansu */
        #map { height: 400px; width: 100%; margin-top: 20px; border-radius: 8px; border: 1px solid #ccc; background-color: #e9ebee; cursor: crosshair; }
        .controls { text-align: center; margin-top: 15px; font-size: 0.9em; }
        #status, #manual_status { font-style: italic; text-align: center; color: #888; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ebee;}
        .button-container { text-align: center; margin-top: 20px; }
        button { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Mapa GPS na żywo</h1>
        <p style="text-align: center; color: #606770;">Kliknij na mapę, aby umieścić pinezkę.</p>
        <div id="map"></div>
        <div class="controls">
            <input type="checkbox" id="autocenter" checked>
            <label for="autocenter">Automatycznie centruj na pinezce GPS</label>
        </div>
    </div>

    <div class="container">
        <h2>Ręcznie wybrany punkt</h2>
        <div class="data-point">
            <span class="label">Szerokość geograficzna:</span>
            <span class="value manual" id="manual_lat">...</span>
        </div>
        <div class="data-point">
            <span class="label">Długość geograficzna:</span>
            <span class="value manual" id="manual_lon">...</span>
        </div>
        <div class="data-point">
            <span class="label">Dystans od punktu GPS:</span>
            <span class="value distance" id="distance">...</span>
        </div>
        <div class="button-container">
            <button id="save_button" disabled>Zapisz punkt</button>
        </div>
        <div id="manual_status"></div>
    </div>

    <div class="container">
        <h2>Dane z modułu GPS</h2>
        <div class="data-point"><span class="label">Szerokość geograficzna:</span><span class="value" id="lat">...</span></div>
        <div class="data-point"><span class="label">Długość geograficzna:</span><span class="value" id="lon">...</span></div>
        <div class="data-point"><span class="label">Wysokość (n.p.m.):</span><span class="value" id="alt">...</span></div>
        <div class="data-point"><span class="label">Jakość sygnału:</span><span class="value" id="fix">...</span></div>
        <div class="data-point"><span class="label">Liczba satelitów:</span><span class="value" id="sats">...</span></div>
        <div id="status">...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            let map;
            let gpsMarker = null;
            let homeMarker = null;
            let manualMarker = null;
            let distanceLine = null;

            map = L.map('map').setView([51.109, 17.032], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

            // USUNIĘTO: Linia kodu dodająca siatkę do mapy

            homeMarker = L.marker([51.109, 17.032]).addTo(map).bindPopup('<b>Nasza lokalizacja</b><br>Wrocław, Polska.').openPopup();

            function updateDistanceAndLine() {
                if (gpsMarker && manualMarker) {
                    const gpsPos = gpsMarker.getLatLng();
                    const manualPos = manualMarker.getLatLng();
                    const distance = gpsPos.distanceTo(manualPos);
                    const distanceDisplay = document.getElementById('distance');
                    if (distance > 1000) {
                        distanceDisplay.innerText = (distance / 1000).toFixed(2) + ' km';
                    } else {
                        distanceDisplay.innerText = distance.toFixed(0) + ' m';
                    }
                    const points = [gpsPos, manualPos];
                    if (!distanceLine) {
                        distanceLine = L.polyline(points, {color: '#dc3545', dashArray: '5, 10'}).addTo(map);
                    } else {
                        distanceLine.setLatLngs(points);
                    }
                } else {
                    document.getElementById('distance').innerText = '...';
                    if (distanceLine) {
                        map.removeLayer(distanceLine);
                        distanceLine = null;
                    }
                }
            }

            map.on('click', function(e) {
                const coords = e.latlng;
                document.getElementById('manual_lat').innerText = coords.lat.toFixed(7);
                document.getElementById('manual_lon').innerText = coords.lng.toFixed(7);
                document.getElementById('save_button').disabled = false;
                document.getElementById('manual_status').innerText = "";

                if (!manualMarker) {
                    manualMarker = L.marker(coords, {draggable: true}).addTo(map);
                    manualMarker.bindPopup('<b>Ręcznie wybrany punkt</b><br>Możesz mnie przeciągać!').openPopup();
                } else {
                    manualMarker.setLatLng(coords);
                }

                updateDistanceAndLine();

                manualMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    document.getElementById('manual_lat').innerText = position.lat.toFixed(7);
                    document.getElementById('manual_lon').innerText = position.lng.toFixed(7);
                    updateDistanceAndLine();
                });
            });

            document.getElementById('save_button').addEventListener('click', function() {
                if (!manualMarker) return;
                const coords = manualMarker.getLatLng();
                fetch('/save_point', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lat: coords.lat, lon: coords.lng }),
                })
                .then(response => response.json())
                .then(result => {
                    document.getElementById('manual_status').innerText = result.message;
                })
                .catch(error => {
                    document.getElementById('manual_status').innerText = 'Wystąpił błąd sieciowy.';
                });
            });

            function updateGpsData() {
                fetch('/data')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('lat').innerText = data.lat.toFixed(7);
                        document.getElementById('lon').innerText = data.lon.toFixed(7);
                        document.getElementById('alt').innerText = data.alt.toFixed(2) + ' m';
                        document.getElementById('fix').innerText = data.fix;
                        document.getElementById('sats').innerText = data.sats;
                        document.getElementById('status').innerText = 'Status serwera: ' + data.status;

                        if ((data.fix === '2D-Fix' || data.fix === '3D-Fix') && data.lat !== 0) {
                            const newPosition = [data.lat, data.lon];
                            if (!gpsMarker) {
                                gpsMarker = L.marker(newPosition).addTo(map).bindPopup('<b>Twoja pozycja GPS</b>');
                                map.setView(newPosition, 16);
                            } else {
                                gpsMarker.setLatLng(newPosition);
                            }
                            if (document.getElementById('autocenter').checked) {
                                map.panTo(newPosition);
                            }
                            updateDistanceAndLine();
                        }
                    });
            }

            setInterval(updateGpsData, 5000);
        });
    </script>
</body>
</html>
